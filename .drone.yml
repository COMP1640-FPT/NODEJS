
kind: pipeline
type: docker
name: default

steps:
- name: restore-cache
  image: drillster/drone-volume-cache
  restore: true
  mount:
  - ./.npm-cache
  - ./node_modules
  volumes:
  - name: cache
    path: /tmp/cache

- name: install
  image: node:alpine
  volumes:
  - name: cache
    path: /tmp/cache
  commands:
  - npm config set cache-folder .npm-cache
  - npm install --pure-lockfile

- name: Publish
  image: plugins/docker
  settings:
    auto_tag: true
    repo: tungduy/nodejs-etutor
    dockerfile: Dockerfile
    username: 
      from_secret: docker_username
    password: 
      from_secret: docker_password

- name: Run Images
  image: appleboy/drone-ssh
  settings:
    host: drone.e-tutor.wtf
    port: 22
    command_timeout: 6m
    username: fbeta
    password:
      from_secret: server_password
    script:
      - docker pull tungduy/nodejs-etutor:latest  
      - docker stop react-app 
      - docker rm react-app
      - docker rmi tungduy/nodejs-etutor:current  
      - docker tag tungduy/nodejs-etutor:latest tungduy/nodejs-etutor:current  
      - docker run -d --name react-app --network fbeta-networks -e PORT=3030 tungduy/nodejs-etutor:latest
  when:
    branch:
      - master
    event:
      - push
    status:
      - success

- name: slack_build
  image: plugins/slack
  settings:
    webhook:
      from_secret: webhook_slack
    channel: drone-notify
    username: drone
    icon_emoji: ':bowtie:'
    link_names: true
    template: >
      {{#success build.status}}
        Build {{build.number}} succeeded and deployed to Production! :)
        Event: {{build.event}}
        Branch: {{build.branch}}
        Tag: {{build.tag}}
        Git SHA: {{build.commit}}
        Link: {{build.link}}
      {{else}}
        Build {{build.number}} failed and not deployed to Production :(
        Event: {{build.event}}
        Branch: {{build.branch}}
        Tag: {{build.tag}}
        Git SHA: {{build.commit}}
        Link: {{build.link}}
      {{/success}}
  when:
    status:
      - success
      - failure

- name: rebuild-cache
  image: drillster/drone-volume-cache
  rebuild: true
  mount:
  - ./node_modules
  - ./.npm-cache
  # Mount the cache volume, needs "Trusted"
  volumes:
  - name: cache
    path: /tmp/cache

volumes:
  - name: cache
    host:
      path: /var/lib/cache